
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>New York City Taxi Fare Data Exploration &#8212; PMC Submission</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="shortcut icon" href="../_static/android-chrome-512x512.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Question 2a: CSV Solution" href="RecordingWeather.html" />
    <link rel="prev" title="Part 1: BigQuery and SQL" href="question_1.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">PMC Submission</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../index.html">
   Justin Napolitano’s Technical Submission to PMC
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Part 1 SQL Queries and Data Exploration
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="question_1.html">
   Part 1: BigQuery and SQL
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   New York City Taxi Fare Data Exploration
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Part 2 Rest Api's and DB's
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="RecordingWeather.html">
   Question 2a: CSV Solution
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="recording_weather_datastream_solution.html">
   Question 2b: Data Streaming Solution via BigTable
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="restful_api.html">
   Restful Api to Upload Data to a BigTable Instance
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Part 3 Logistic Regression Model of Customer Churn Rate
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="propensity_scoring.html">
   Churn Modelling Marketing Data with Julia
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/notebooks/nyc-taxi-fare-data-exploration.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/justin-napolitano/pmc-submission"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/justin-napolitano/pmc-submission/master?urlpath=tree/jupyter-book/notebooks/nyc-taxi-fare-data-exploration.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reading-data-and-first-impressions">
   Reading Data and First Impressions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#querying-the-green-cab-data-set">
   Querying the Green Cab Data Set.
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sql-import-functions">
     SQL Import Functions
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#remove-missing-data">
   Remove missing data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#location-data">
   Location data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#adding-a-geometry-column-to-the-table">
     Adding a Geometry column to the table
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#checking-coordinate-system">
     Checking Coordinate System
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#datapoint-density-per-sq-mile">
     Datapoint density per sq mile
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pickup-traffic-density">
   Pickup traffic density
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#distance-and-time-visualisations">
   Distance and time visualisations
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-longer-the-distance-between-pickup-and-dropoff-location-the-higher-the-fare">
     The longer the distance between pickup and dropoff location, the higher the fare
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#some-trips-like-to-from-an-airport-are-fixed-fee">
   Some trips, like to/from an airport, are fixed fee
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fare-per-mile">
   Fare Per Mile
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fare-varies-with-pickup-location">
   Fare varies with pickup location
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#final-thoughts">
   Final Thoughts
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>New York City Taxi Fare Data Exploration</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reading-data-and-first-impressions">
   Reading Data and First Impressions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#querying-the-green-cab-data-set">
   Querying the Green Cab Data Set.
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sql-import-functions">
     SQL Import Functions
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#remove-missing-data">
   Remove missing data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#location-data">
   Location data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#adding-a-geometry-column-to-the-table">
     Adding a Geometry column to the table
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#checking-coordinate-system">
     Checking Coordinate System
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#datapoint-density-per-sq-mile">
     Datapoint density per sq mile
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pickup-traffic-density">
   Pickup traffic density
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#distance-and-time-visualisations">
   Distance and time visualisations
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-longer-the-distance-between-pickup-and-dropoff-location-the-higher-the-fare">
     The longer the distance between pickup and dropoff location, the higher the fare
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#some-trips-like-to-from-an-airport-are-fixed-fee">
   Some trips, like to/from an airport, are fixed fee
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fare-per-mile">
   Fare Per Mile
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fare-varies-with-pickup-location">
   Fare varies with pickup location
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#final-thoughts">
   Final Thoughts
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="new-york-city-taxi-fare-data-exploration">
<h1>New York City Taxi Fare Data Exploration<a class="headerlink" href="#new-york-city-taxi-fare-data-exploration" title="Permalink to this headline">¶</a></h1>
<div class="section" id="reading-data-and-first-impressions">
<h2>Reading Data and First Impressions<a class="headerlink" href="#reading-data-and-first-impressions" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load some default Python modules</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-whitegrid&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">google.cloud</span> <span class="kn">import</span> <span class="n">bigquery</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">folium</span>
<span class="kn">import</span> <span class="nn">geopandas</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">contextily</span> <span class="k">as</span> <span class="nn">cx</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="querying-the-green-cab-data-set">
<h2>Querying the Green Cab Data Set.<a class="headerlink" href="#querying-the-green-cab-data-set" title="Permalink to this headline">¶</a></h2>
<p>The queries below clean the data and prepare it for analysis.</p>
<div class="section" id="sql-import-functions">
<h3>SQL Import Functions<a class="headerlink" href="#sql-import-functions" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">query_big_query</span><span class="p">(</span><span class="n">query_string</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
    <span class="n">query_job</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">query_job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>  <span class="c1"># Waits for job to complete.</span>
    <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">clean_up_data</span><span class="p">():</span>

  <span class="n">query_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">      SELECT </span>
<span class="s2">      t.*,</span>
<span class="s2">      FROM</span>
<span class="s2">      (</span>
<span class="s2">      SELECT *,</span>
<span class="s2">      TIMESTAMP_DIFF(dropoff_datetime,pickup_datetime,SECOND) as time_duration_in_secs,</span>
<span class="s2">      TIMESTAMP_DIFF(dropoff_datetime,pickup_datetime,MINUTE) as time_duration_in_mins,</span>
<span class="s2">      ROUND(trip_distance/TIMESTAMP_DIFF(dropoff_datetime,pickup_datetime,SECOND),2)*3600 as driving_speed_miles_per_hour,</span>
<span class="s2">      (CASE WHEN total_amount=0 THEN 0</span>
<span class="s2">      ELSE ROUND(tip_amount*100/total_amount,2) END) as tip_rate,</span>
<span class="s2">      EXTRACT(YEAR from pickup_datetime) as pickup_year,</span>
<span class="s2">      EXTRACT(MONTH from pickup_datetime) as pickup_month,</span>
<span class="s2">      CONCAT(CAST(EXTRACT(YEAR from pickup_datetime) as STRING),&quot;-&quot;,CAST(EXTRACT(MONTH from pickup_datetime) AS STRING)) as pickup_yearmonth,</span>
<span class="s2">      EXTRACT(DATE from pickup_datetime) as pickup_date,</span>
<span class="s2">      FORMAT_DATE(&#39;%A&#39;,DATE(pickup_datetime)) as pickup_weekday_name,</span>
<span class="s2">      EXTRACT(HOUR from pickup_datetime) as pickup_hour,</span>
<span class="s2">      EXTRACT(YEAR from dropoff_datetime) as dropoff_year,</span>
<span class="s2">      EXTRACT(MONTH from dropoff_datetime) as dropoff_month,</span>
<span class="s2">      CONCAT(CAST(EXTRACT(YEAR from dropoff_datetime) as STRING),&quot;-&quot;,CAST(EXTRACT(MONTH from dropoff_datetime) AS STRING)) as dropoff_yearmonth,</span>
<span class="s2">      EXTRACT(DATE from dropoff_datetime) as dropoff_date,</span>
<span class="s2">      FORMAT_DATE(&#39;%A&#39;,DATE(dropoff_datetime)) as dropoff_weekday_name,</span>
<span class="s2">      EXTRACT(HOUR from dropoff_datetime) as dropoff_hour</span>
<span class="s2">      FROM `nyc-tlc.green.trips_2015`</span>
<span class="s2">      /* filter by latitude &amp; longitude that are within the correct range */</span>
<span class="s2">      WHERE </span>
<span class="s2">          ((pickup_latitude BETWEEN -90 AND 90) AND</span>
<span class="s2">            (pickup_longitude BETWEEN -180 AND 180)) </span>
<span class="s2">            AND</span>
<span class="s2">              ((dropoff_latitude BETWEEN -90 AND 90) AND</span>
<span class="s2">              (dropoff_longitude BETWEEN -180 AND 180))</span>
<span class="s2">      ) t</span>
<span class="s2">      WHERE </span>
<span class="s2">      pickup_datetime BETWEEN &#39;2015-01-01&#39; AND &#39;2016-12-31&#39; </span>
<span class="s2">      AND dropoff_datetime BETWEEN &#39;2015-01-01&#39; AND &#39;2016-12-31&#39;</span>
<span class="s2">      AND TIMESTAMP_DIFF(dropoff_datetime,pickup_datetime,SECOND) &gt; 0</span>
<span class="s2">      AND passenger_count &gt; 0</span>
<span class="s2">      AND trip_distance &gt;= 0 </span>
<span class="s2">      AND tip_amount &gt;= 0 </span>
<span class="s2">      AND tolls_amount &gt;= 0 </span>
<span class="s2">      AND mta_tax &gt;= 0 </span>
<span class="s2">      AND fare_amount &gt;= 0</span>
<span class="s2">      AND total_amount &gt;= 0</span>
<span class="s2">      order by pickup_date DESC</span>
<span class="s2">      limit 1000000</span>
<span class="s2">      &quot;&quot;&quot;</span>


  <span class="n">result</span> <span class="o">=</span> <span class="n">query_big_query</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
      
  <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>

<span class="n">clean_df</span> <span class="o">=</span> <span class="n">clean_up_data</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># read data in pandas dataframe</span>


<span class="c1"># list first few rows (datapoints)</span>
<span class="n">clean_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pickup_datetime</th>
      <th>dropoff_datetime</th>
      <th>store_and_fwd_flag</th>
      <th>rate_code</th>
      <th>pickup_longitude</th>
      <th>pickup_latitude</th>
      <th>dropoff_longitude</th>
      <th>dropoff_latitude</th>
      <th>passenger_count</th>
      <th>trip_distance</th>
      <th>...</th>
      <th>pickup_yearmonth</th>
      <th>pickup_date</th>
      <th>pickup_weekday_name</th>
      <th>pickup_hour</th>
      <th>dropoff_year</th>
      <th>dropoff_month</th>
      <th>dropoff_yearmonth</th>
      <th>dropoff_date</th>
      <th>dropoff_weekday_name</th>
      <th>dropoff_hour</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2015-06-30 16:11:08+00:00</td>
      <td>2015-06-30 16:18:33+00:00</td>
      <td>N</td>
      <td>1</td>
      <td>-73.943321</td>
      <td>40.785267</td>
      <td>-73.935303</td>
      <td>40.800449</td>
      <td>1</td>
      <td>1.49</td>
      <td>...</td>
      <td>2015-6</td>
      <td>2015-06-30</td>
      <td>Tuesday</td>
      <td>16</td>
      <td>2015</td>
      <td>6</td>
      <td>2015-6</td>
      <td>2015-06-30</td>
      <td>Tuesday</td>
      <td>16</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2015-06-30 14:06:56+00:00</td>
      <td>2015-06-30 14:44:59+00:00</td>
      <td>N</td>
      <td>1</td>
      <td>-73.951302</td>
      <td>40.689251</td>
      <td>-73.999634</td>
      <td>40.634769</td>
      <td>1</td>
      <td>5.74</td>
      <td>...</td>
      <td>2015-6</td>
      <td>2015-06-30</td>
      <td>Tuesday</td>
      <td>14</td>
      <td>2015</td>
      <td>6</td>
      <td>2015-6</td>
      <td>2015-06-30</td>
      <td>Tuesday</td>
      <td>14</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2015-06-30 08:50:52+00:00</td>
      <td>2015-06-30 08:56:16+00:00</td>
      <td>N</td>
      <td>1</td>
      <td>-73.944077</td>
      <td>40.721775</td>
      <td>-73.944504</td>
      <td>40.714703</td>
      <td>1</td>
      <td>0.63</td>
      <td>...</td>
      <td>2015-6</td>
      <td>2015-06-30</td>
      <td>Tuesday</td>
      <td>8</td>
      <td>2015</td>
      <td>6</td>
      <td>2015-6</td>
      <td>2015-06-30</td>
      <td>Tuesday</td>
      <td>8</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2015-06-30 03:55:39+00:00</td>
      <td>2015-06-30 04:09:03+00:00</td>
      <td>N</td>
      <td>1</td>
      <td>-73.854630</td>
      <td>40.742798</td>
      <td>-73.905746</td>
      <td>40.747269</td>
      <td>2</td>
      <td>3.26</td>
      <td>...</td>
      <td>2015-6</td>
      <td>2015-06-30</td>
      <td>Tuesday</td>
      <td>3</td>
      <td>2015</td>
      <td>6</td>
      <td>2015-6</td>
      <td>2015-06-30</td>
      <td>Tuesday</td>
      <td>4</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2015-06-30 01:38:08+00:00</td>
      <td>2015-06-30 01:55:25+00:00</td>
      <td>N</td>
      <td>1</td>
      <td>-73.910698</td>
      <td>40.658485</td>
      <td>-73.971657</td>
      <td>40.697437</td>
      <td>1</td>
      <td>5.35</td>
      <td>...</td>
      <td>2015-6</td>
      <td>2015-06-30</td>
      <td>Tuesday</td>
      <td>1</td>
      <td>2015</td>
      <td>6</td>
      <td>2015-6</td>
      <td>2015-06-30</td>
      <td>Tuesday</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 37 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># check datatypes</span>
<span class="n">clean_df</span><span class="o">.</span><span class="n">dtypes</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>pickup_datetime                 datetime64[ns, UTC]
dropoff_datetime                datetime64[ns, UTC]
store_and_fwd_flag                           object
rate_code                                     Int64
pickup_longitude                            float64
pickup_latitude                             float64
dropoff_longitude                           float64
dropoff_latitude                            float64
passenger_count                               Int64
trip_distance                               float64
fare_amount                                 float64
extra                                       float64
mta_tax                                     float64
tip_amount                                  float64
tolls_amount                                float64
ehail_fee                                   float64
total_amount                                float64
payment_type                                  Int64
distance_between_service                    float64
time_between_service                          Int64
trip_type                                     Int64
time_duration_in_secs                         Int64
time_duration_in_mins                         Int64
driving_speed_miles_per_hour                float64
tip_rate                                    float64
pickup_year                                   Int64
pickup_month                                  Int64
pickup_yearmonth                             object
pickup_date                                  dbdate
pickup_weekday_name                          object
pickup_hour                                   Int64
dropoff_year                                  Int64
dropoff_month                                 Int64
dropoff_yearmonth                            object
dropoff_date                                 dbdate
dropoff_weekday_name                         object
dropoff_hour                                  Int64
dtype: object
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># check statistics of the features</span>
<span class="n">clean_df</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rate_code</th>
      <th>pickup_longitude</th>
      <th>pickup_latitude</th>
      <th>dropoff_longitude</th>
      <th>dropoff_latitude</th>
      <th>passenger_count</th>
      <th>trip_distance</th>
      <th>fare_amount</th>
      <th>extra</th>
      <th>mta_tax</th>
      <th>...</th>
      <th>time_duration_in_secs</th>
      <th>time_duration_in_mins</th>
      <th>driving_speed_miles_per_hour</th>
      <th>tip_rate</th>
      <th>pickup_year</th>
      <th>pickup_month</th>
      <th>pickup_hour</th>
      <th>dropoff_year</th>
      <th>dropoff_month</th>
      <th>dropoff_hour</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>1000000.000000</td>
      <td>1000000.000000</td>
      <td>1000000.000000</td>
      <td>1000000.000000</td>
      <td>1000000.000000</td>
      <td>1000000.000000</td>
      <td>1000000.000000</td>
      <td>1000000.000000</td>
      <td>1000000.000000</td>
      <td>1000000.000000</td>
      <td>...</td>
      <td>1000000.000000</td>
      <td>1000000.000000</td>
      <td>1000000.000000</td>
      <td>1000000.000000</td>
      <td>1000000.0</td>
      <td>1000000.0</td>
      <td>1000000.000000</td>
      <td>1000000.0</td>
      <td>1000000.000000</td>
      <td>1000000.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>1.099227</td>
      <td>-73.837842</td>
      <td>40.695889</td>
      <td>-73.880229</td>
      <td>40.717875</td>
      <td>1.381162</td>
      <td>2.906045</td>
      <td>12.525830</td>
      <td>0.344684</td>
      <td>0.487888</td>
      <td>...</td>
      <td>882.663591</td>
      <td>14.223966</td>
      <td>7.781940</td>
      <td>6.415084</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>13.324359</td>
      <td>2015.0</td>
      <td>6.000423</td>
      <td>13.277533</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.611234</td>
      <td>2.669467</td>
      <td>1.472229</td>
      <td>1.975514</td>
      <td>1.089994</td>
      <td>1.054405</td>
      <td>2.986171</td>
      <td>10.911337</td>
      <td>0.362626</td>
      <td>0.076872</td>
      <td>...</td>
      <td>2706.093278</td>
      <td>45.101709</td>
      <td>142.204973</td>
      <td>8.870430</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>6.894272</td>
      <td>0.0</td>
      <td>0.020563</td>
      <td>6.969866</td>
    </tr>
    <tr>
      <th>min</th>
      <td>1.000000</td>
      <td>-75.845970</td>
      <td>0.000000</td>
      <td>-75.845978</td>
      <td>0.000000</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>...</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>0.000000</td>
      <td>2015.0</td>
      <td>6.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>1.000000</td>
      <td>-73.958794</td>
      <td>40.699097</td>
      <td>-73.966631</td>
      <td>40.699371</td>
      <td>1.000000</td>
      <td>1.090000</td>
      <td>6.500000</td>
      <td>0.000000</td>
      <td>0.500000</td>
      <td>...</td>
      <td>371.000000</td>
      <td>6.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>9.000000</td>
      <td>2015.0</td>
      <td>6.000000</td>
      <td>8.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>1.000000</td>
      <td>-73.944382</td>
      <td>40.746868</td>
      <td>-73.943459</td>
      <td>40.747639</td>
      <td>1.000000</td>
      <td>1.930000</td>
      <td>9.500000</td>
      <td>0.500000</td>
      <td>0.500000</td>
      <td>...</td>
      <td>622.000000</td>
      <td>10.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>15.000000</td>
      <td>2015.0</td>
      <td>6.000000</td>
      <td>15.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>1.000000</td>
      <td>-73.914879</td>
      <td>40.802990</td>
      <td>-73.907227</td>
      <td>40.791172</td>
      <td>1.000000</td>
      <td>3.670000</td>
      <td>15.000000</td>
      <td>0.500000</td>
      <td>0.500000</td>
      <td>...</td>
      <td>1029.000000</td>
      <td>17.000000</td>
      <td>0.000000</td>
      <td>16.670000</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>19.000000</td>
      <td>2015.0</td>
      <td>6.000000</td>
      <td>19.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>6.000000</td>
      <td>0.000000</td>
      <td>42.464546</td>
      <td>0.000000</td>
      <td>42.464554</td>
      <td>9.000000</td>
      <td>210.300000</td>
      <td>1008.500000</td>
      <td>2.500000</td>
      <td>0.500000</td>
      <td>...</td>
      <td>86368.000000</td>
      <td>1439.000000</td>
      <td>36540.000000</td>
      <td>100.000000</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>23.000000</td>
      <td>2015.0</td>
      <td>7.000000</td>
      <td>23.000000</td>
    </tr>
  </tbody>
</table>
<p>8 rows × 28 columns</p>
</div></div></div>
</div>
<p>Checking for negative values and anything else I missed from the initial sql clean:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Old size: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">clean_df</span><span class="p">))</span>
<span class="n">clean_df</span> <span class="o">=</span> <span class="n">clean_df</span><span class="p">[</span><span class="n">clean_df</span><span class="o">.</span><span class="n">fare_amount</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;New size: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">clean_df</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Old size: 1000000
New size: 1000000
</pre></div>
</div>
</div>
</div>
<p>No negative values reported.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot histogram of fare</span>
<span class="n">clean_df</span><span class="p">[</span><span class="n">clean_df</span><span class="o">.</span><span class="n">fare_amount</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">fare_amount</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;fare $USD&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Histogram&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/nyc-taxi-fare-data-exploration_12_0.png" src="../_images/nyc-taxi-fare-data-exploration_12_0.png" />
</div>
</div>
<p>In the histogram of the <code class="docutils literal notranslate"><span class="pre">fare_amount</span></code> there are some small spikes between $40 and $55. This could indicate some fixed fare price (e.g. to/from airport). This will be explored further.</p>
<p>Also the graph is unusually not biased towards the right.  The minimum rate must reduce the possibility of a normal distribution.</p>
</div>
</div>
<div class="section" id="remove-missing-data">
<h2>Remove missing data<a class="headerlink" href="#remove-missing-data" title="Permalink to this headline">¶</a></h2>
<p>Always check to see if there is missing data. As this dataset is huge, removing datapoints with missing data probably has no effect on the models beings trained.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">clean_df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>pickup_datetime                       0
dropoff_datetime                      0
store_and_fwd_flag                    0
rate_code                             0
pickup_longitude                      0
pickup_latitude                       0
dropoff_longitude                     0
dropoff_latitude                      0
passenger_count                       0
trip_distance                         0
fare_amount                           0
extra                                 0
mta_tax                               0
tip_amount                            0
tolls_amount                          0
ehail_fee                       1000000
total_amount                          0
payment_type                          0
distance_between_service              0
time_between_service                  0
trip_type                             0
time_duration_in_secs                 0
time_duration_in_mins                 0
driving_speed_miles_per_hour          0
tip_rate                              0
pickup_year                           0
pickup_month                          0
pickup_yearmonth                      0
pickup_date                           0
pickup_weekday_name                   0
pickup_hour                           0
dropoff_year                          0
dropoff_month                         0
dropoff_yearmonth                     0
dropoff_date                          0
dropoff_weekday_name                  0
dropoff_hour                          0
dtype: int64
</pre></div>
</div>
</div>
</div>
<p>The only data points with null are thee ehail_fees.  It is negative a cross every data point.  I’l just drop the column</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Old size: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">clean_df</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
<span class="n">clean_df</span><span class="o">=</span> <span class="n">clean_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">clean_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">!=</span> <span class="s2">&quot;ehail_fee&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;New size: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">clean_df</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Old size: 37000000
New size: 36000000
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="location-data">
<h2>Location data<a class="headerlink" href="#location-data" title="Permalink to this headline">¶</a></h2>
<p>As we’re dealing with location data, I want to plot the coordinates on a map. This gives a better view of the data. For this, I use the following website:</p>
<p>New York city coordinates are (<a class="reference external" href="https://www.travelmath.com/cities/New+York,+NY">https://www.travelmath.com/cities/New+York,+NY</a>):</p>
<ul class="simple">
<li><p>longitude = -74.0063889</p></li>
<li><p>lattitude = 40.7141667</p></li>
</ul>
<p>I define a bounding box of interest by [long_min, long_max, latt_min, latt_max] using the minimum and maximum coordinates from the testset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># minimum and maximum longitude test set</span>
<span class="nb">min</span><span class="p">(</span><span class="n">clean_df</span><span class="o">.</span><span class="n">pickup_longitude</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">clean_df</span><span class="o">.</span><span class="n">dropoff_longitude</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> \
<span class="nb">max</span><span class="p">(</span><span class="n">clean_df</span><span class="o">.</span><span class="n">pickup_longitude</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">clean_df</span><span class="o">.</span><span class="n">dropoff_longitude</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(-75.84597778320312, 0.0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># minimum and maximum latitude test</span>
<span class="nb">min</span><span class="p">(</span><span class="n">clean_df</span><span class="o">.</span><span class="n">pickup_latitude</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">clean_df</span><span class="o">.</span><span class="n">dropoff_latitude</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> \
<span class="nb">max</span><span class="p">(</span><span class="n">clean_df</span><span class="o">.</span><span class="n">pickup_latitude</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">clean_df</span><span class="o">.</span><span class="n">dropoff_latitude</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(0.0, 42.46455383300781)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># this function will also be used with the test set below</span>
<span class="k">def</span> <span class="nf">select_within_boundingbox</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">BB</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pickup_longitude</span> <span class="o">&gt;=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pickup_longitude</span> <span class="o">&lt;=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> \
           <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pickup_latitude</span> <span class="o">&gt;=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pickup_latitude</span> <span class="o">&lt;=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&amp;</span> \
           <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dropoff_longitude</span> <span class="o">&gt;=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dropoff_longitude</span> <span class="o">&lt;=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> \
           <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dropoff_latitude</span> <span class="o">&gt;=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dropoff_latitude</span> <span class="o">&lt;=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            
<span class="c1"># load image of NYC map</span>
<span class="n">BB</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">74.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">72.8</span><span class="p">,</span> <span class="mf">40.5</span><span class="p">,</span> <span class="mf">41.8</span><span class="p">)</span>
<span class="c1">#nyc_map = plt.imread(&#39;https://aiblog.nl/download/nyc_-74.5_-72.8_40.5_41.8.png&#39;)</span>

<span class="c1"># load extra image to zoom in on NYC</span>
<span class="n">BB_zoom</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">74.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">73.7</span><span class="p">,</span> <span class="mf">40.5</span><span class="p">,</span> <span class="mf">40.9</span><span class="p">)</span>
<span class="c1">#nyc_map_zoom = plt.imread(&#39;https://aiblog.nl/download/nyc_-74.3_-73.7_40.5_40.9.png&#39;)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Old size: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">clean_df</span><span class="p">))</span>
<span class="n">clean_df</span> <span class="o">=</span> <span class="n">clean_df</span><span class="p">[</span><span class="n">select_within_boundingbox</span><span class="p">(</span><span class="n">clean_df</span><span class="p">,</span> <span class="n">BB</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;New size: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">clean_df</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Old size: 1000000
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>New size: 998236
</pre></div>
</div>
</div>
</div>
<div class="section" id="adding-a-geometry-column-to-the-table">
<h3>Adding a Geometry column to the table<a class="headerlink" href="#adding-a-geometry-column-to-the-table" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">json_serial</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;JSON serializer for objects not serializable by default json code&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="p">,</span> <span class="n">date</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
    <span class="k">raise</span> <span class="ne">TypeError</span> <span class="p">(</span><span class="s2">&quot;Type </span><span class="si">%s</span><span class="s2"> not serializable&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gdf</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
    <span class="n">clean_df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">geopandas</span><span class="o">.</span><span class="n">points_from_xy</span><span class="p">(</span><span class="n">clean_df</span><span class="o">.</span><span class="n">pickup_longitude</span><span class="p">,</span> <span class="n">clean_df</span><span class="o">.</span><span class="n">pickup_latitude</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>When using interactie maps, all of the columns within a df must be json seriable to interact with apis.  The code below serializes all of the date columns for plottin.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gdf</span><span class="o">.</span><span class="n">pickup_datetime</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">pickup_datetime</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">json_serial</span><span class="p">)</span>
<span class="n">gdf</span><span class="o">.</span><span class="n">dropoff_datetime</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">dropoff_datetime</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">json_serial</span><span class="p">)</span>
<span class="n">gdf</span><span class="o">.</span><span class="n">dropoff_date</span> <span class="o">=</span>  <span class="n">gdf</span><span class="o">.</span><span class="n">dropoff_date</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">json_serial</span><span class="p">)</span>
<span class="n">gdf</span><span class="o">.</span><span class="n">pickup_date</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">pickup_date</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">json_serial</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gdf</span><span class="o">.</span><span class="n">dtypes</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>pickup_datetime                   object
dropoff_datetime                  object
store_and_fwd_flag                object
rate_code                          Int64
pickup_longitude                 float64
pickup_latitude                  float64
dropoff_longitude                float64
dropoff_latitude                 float64
passenger_count                    Int64
trip_distance                    float64
fare_amount                      float64
extra                            float64
mta_tax                          float64
tip_amount                       float64
tolls_amount                     float64
total_amount                     float64
payment_type                       Int64
distance_between_service         float64
time_between_service               Int64
trip_type                          Int64
time_duration_in_secs              Int64
time_duration_in_mins              Int64
driving_speed_miles_per_hour     float64
tip_rate                         float64
pickup_year                        Int64
pickup_month                       Int64
pickup_yearmonth                  object
pickup_date                       object
pickup_weekday_name               object
pickup_hour                        Int64
dropoff_year                       Int64
dropoff_month                      Int64
dropoff_yearmonth                 object
dropoff_date                      object
dropoff_weekday_name              object
dropoff_hour                       Int64
geometry                        geometry
dtype: object
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="checking-coordinate-system">
<h3>Checking Coordinate System<a class="headerlink" href="#checking-coordinate-system" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#gdf = EPSG:3857</span>
<span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="s2">&quot;EPSG:4236&quot;</span>
<span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">3857</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mf">.01</span><span class="p">)</span>
<span class="n">cx</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span><span class="n">ax</span><span class="p">,)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/nyc-taxi-fare-data-exploration_31_0.png" src="../_images/nyc-taxi-fare-data-exploration_31_0.png" />
</div>
</div>
</div>
<div class="section" id="datapoint-density-per-sq-mile">
<h3>Datapoint density per sq mile<a class="headerlink" href="#datapoint-density-per-sq-mile" title="Permalink to this headline">¶</a></h3>
<p>A scatterplot of the pickup and dropoff locations gives a quick impression of the density. However, it is more accurate to count the number of datapoints per area to visualize the density. The code below counts pickup and dropoff datapoints per sq miles. This gives a better view on the ‘hot spots’.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For this plot and further analysis, we need a function to calculate the distance in miles between locations in lon,lat coordinates.</span>
<span class="c1"># This function is based on https://stackoverflow.com/questions/27928/</span>
<span class="c1"># calculate-distance-between-two-latitude-longitude-points-haversine-formula </span>
<span class="c1"># return distance in miles</span>
<span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="mf">0.017453292519943295</span> <span class="c1"># Pi/180</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="n">lat2</span> <span class="o">-</span> <span class="n">lat1</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat1</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat2</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="n">lon2</span> <span class="o">-</span> <span class="n">lon1</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="mf">0.6213712</span> <span class="o">*</span> <span class="mi">12742</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="c1"># 2*R*asin...</span>

<span class="c1"># First calculate two arrays with datapoint density per sq mile</span>
<span class="n">n_lon</span><span class="p">,</span> <span class="n">n_lat</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span> <span class="c1"># number of grid bins per longitude, latitude dimension</span>
<span class="n">density_pickup</span><span class="p">,</span> <span class="n">density_dropoff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_lat</span><span class="p">,</span> <span class="n">n_lon</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_lat</span><span class="p">,</span> <span class="n">n_lon</span><span class="p">))</span> <span class="c1"># prepare arrays</span>

<span class="c1"># To calculate the number of datapoints in a grid area, the numpy.digitize() function is used. </span>
<span class="c1"># This function needs an array with the (location) bins for counting the number of datapoints</span>
<span class="c1"># per bin.</span>
<span class="n">bins_lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_lon</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># bin</span>
<span class="n">bins_lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_lat</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># bin</span>
<span class="n">delta_lon</span> <span class="o">=</span> <span class="p">(</span><span class="n">BB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">BB</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">n_lon</span> <span class="c1"># bin longutide width</span>
<span class="n">delta_lat</span> <span class="o">=</span> <span class="p">(</span><span class="n">BB</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">BB</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">n_lat</span> <span class="c1"># bin latitude height</span>
<span class="n">bin_width_miles</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">BB</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">BB</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">BB</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">BB</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">n_lon</span> <span class="c1"># bin width in miles</span>
<span class="n">bin_height_miles</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">BB</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">BB</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">BB</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">BB</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">n_lat</span> <span class="c1"># bin height in miles</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_lon</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">bins_lon</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">delta_lon</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_lat</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">bins_lat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">BB</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="n">delta_lat</span>
    
<span class="c1"># Digitize per longitude, latitude dimension</span>
<span class="n">inds_pickup_lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">clean_df</span><span class="o">.</span><span class="n">pickup_longitude</span><span class="p">,</span> <span class="n">bins_lon</span><span class="p">)</span>
<span class="n">inds_pickup_lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">clean_df</span><span class="o">.</span><span class="n">pickup_latitude</span><span class="p">,</span> <span class="n">bins_lat</span><span class="p">)</span>
<span class="n">inds_dropoff_lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">clean_df</span><span class="o">.</span><span class="n">dropoff_longitude</span><span class="p">,</span> <span class="n">bins_lon</span><span class="p">)</span>
<span class="n">inds_dropoff_lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">clean_df</span><span class="o">.</span><span class="n">dropoff_latitude</span><span class="p">,</span> <span class="n">bins_lat</span><span class="p">)</span>

<span class="c1"># Count per grid bin</span>
<span class="c1"># note: as the density_pickup will be displayed as image, the first index is the y-direction, </span>
<span class="c1">#       the second index is the x-direction. Also, the y-direction needs to be reversed for</span>
<span class="c1">#       properly displaying (therefore the (n_lat-j) term)</span>
<span class="n">dxdy</span> <span class="o">=</span> <span class="n">bin_width_miles</span> <span class="o">*</span> <span class="n">bin_height_miles</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_lon</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_lat</span><span class="p">):</span>
        <span class="n">density_pickup</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">inds_pickup_lon</span><span class="o">==</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">inds_pickup_lat</span><span class="o">==</span><span class="p">(</span><span class="n">n_lat</span><span class="o">-</span><span class="n">j</span><span class="p">)))</span> <span class="o">/</span> <span class="n">dxdy</span>
        <span class="n">density_dropoff</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">inds_dropoff_lon</span><span class="o">==</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">inds_dropoff_lat</span><span class="o">==</span><span class="p">(</span><span class="n">n_lat</span><span class="o">-</span><span class="n">j</span><span class="p">)))</span> <span class="o">/</span> <span class="n">dxdy</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the density arrays</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">24</span><span class="p">))</span>
<span class="c1">#axs[0].imshow(nyc_map, zorder=0, extent=BB);</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">density_pickup</span><span class="p">),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">BB</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;plasma&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Pickup density [datapoints per sq mile]&#39;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;log(1 + #datapoints per sq mile)&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">)</span>
<span class="n">cx</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">crs</span><span class="o">=</span><span class="mi">4236</span><span class="p">)</span>

<span class="c1">#axs[1].imshow(nyc_map, zorder=0, extent=BB);</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">density_dropoff</span><span class="p">),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">BB</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;plasma&#39;</span><span class="p">)</span>
<span class="n">cx</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">crs</span><span class="o">=</span><span class="mi">4236</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Dropoff density [datapoints per sq mile]&#39;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;log(1 + #datapoints per sq mile)&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_25201/3595766640.py:6: MatplotlibDeprecationWarning: Auto-removal of grids by pcolor() and pcolormesh() is deprecated since 3.5 and will be removed two minor releases later; please call grid(False) first.
  cbar = fig.colorbar(im, ax=axs[0])
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_25201/3595766640.py:14: MatplotlibDeprecationWarning: Auto-removal of grids by pcolor() and pcolormesh() is deprecated since 3.5 and will be removed two minor releases later; please call grid(False) first.
  cbar = fig.colorbar(im, ax=axs[1])
</pre></div>
</div>
<img alt="../_images/nyc-taxi-fare-data-exploration_34_2.png" src="../_images/nyc-taxi-fare-data-exploration_34_2.png" />
</div>
</div>
<p>These plots clearly show that the datapoints concentrate around Manhatten and the three airports (JFK, EWS, LGR).</p>
</div>
</div>
<div class="section" id="pickup-traffic-density">
<h2>Pickup traffic density<a class="headerlink" href="#pickup-traffic-density" title="Permalink to this headline">¶</a></h2>
<p>The density plots of above triggered me to see if I can visualize traffic density by the hour (and year). By counting the number of pickups in an area we should get some impression of the traffic density. The more traffic, the longer it could take to make a drive.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add time information</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;monday&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;tuesday&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;wednesday&#39;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;thursday&#39;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;friday&#39;</span> <span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;saturday&#39;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;sunday&#39;</span> <span class="p">:</span> <span class="mi">6</span><span class="p">}</span>
<span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;pickup_weekday_name_test&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;pickup_weekday_name&quot;</span><span class="p">]</span>
<span class="n">gdf</span><span class="o">.</span><span class="n">pickup_weekday_name</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;pickup_weekday_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>
<span class="n">gdf</span><span class="o">.</span><span class="n">dropoff_weekday_name</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;dropoff_weekday_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>

<span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;pickup_codes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">pickup_weekday_name</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;dropoff_codes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">dropoff_weekday_name</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># some constants needed to calculate pickup traffic density</span>
<span class="n">n_hours</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">n_weekdays</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">n_years</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">n_bins_lon</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">n_bins_lat</span> <span class="o">=</span> <span class="mi">30</span>

<span class="c1"># focus on traffic in Manhattan</span>
<span class="n">BB_traffic</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">74.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">72.8</span><span class="p">,</span> <span class="mf">40.5</span><span class="p">,</span> <span class="mf">41.8</span><span class="p">)</span>

<span class="c1"># define function to calculate pickup traffic density</span>
<span class="k">def</span> <span class="nf">calculate_trafic_density</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">traffic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_years</span><span class="p">,</span> <span class="n">n_weekdays</span><span class="p">,</span> <span class="n">n_hours</span><span class="p">,</span> <span class="n">n_bins_lat</span><span class="p">,</span> <span class="n">n_bins_lon</span><span class="p">))</span>
    
    <span class="c1"># To calculate the number of datapoints in a grid area, the numpy.digitize() function is used. </span>
    <span class="c1"># This function needs an array with the (location) bins for counting the number of datapoints</span>
    <span class="c1"># per bin.</span>
    <span class="n">bins_lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_bins_lon</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># bin</span>
    <span class="n">bins_lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_bins_lat</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># bin</span>
    
    <span class="n">delta_lon</span> <span class="o">=</span> <span class="p">(</span><span class="n">BB_traffic</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">BB_traffic</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">n_bins_lon</span> <span class="c1"># bin longutide width</span>
    <span class="n">delta_lat</span> <span class="o">=</span> <span class="p">(</span><span class="n">BB_traffic</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">BB_traffic</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">n_bins_lat</span> <span class="c1"># bin latitude height</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_bins_lon</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">bins_lon</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">BB_traffic</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">delta_lon</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_bins_lat</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">bins_lat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">BB_traffic</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="n">delta_lat</span>
    
    <span class="c1"># Count per grid bin</span>
    <span class="c1"># note: as the density_pickup will be displayed as image, the first index is the y-direction, </span>
    <span class="c1">#       the second index is the x-direction. Also, the y-direction needs to be reversed for</span>
    <span class="c1">#       properly displaying (therefore the (n_lat-j) term)</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_years</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_weekdays</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_hours</span><span class="p">):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pickup_year</span><span class="p">)</span><span class="o">==</span><span class="p">(</span><span class="mi">2009</span><span class="o">+</span><span class="n">y</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pickup_codes</span><span class="o">==</span><span class="n">d</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pickup_hour</span><span class="p">)</span><span class="o">==</span><span class="n">h</span><span class="p">)</span>

                <span class="c1"># Digitize per longitude, latitude dimension</span>
                <span class="n">inds_pickup_lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">pickup_longitude</span><span class="p">,</span> <span class="n">bins_lon</span><span class="p">)</span>
                <span class="n">inds_pickup_lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">pickup_latitude</span><span class="p">,</span> <span class="n">bins_lat</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_bins_lon</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_bins_lat</span><span class="p">):</span>
                        <span class="n">traffic</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">traffic</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> \
                                                 <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">inds_pickup_lon</span><span class="o">==</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">inds_pickup_lat</span><span class="o">==</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">traffic</span> 

<span class="c1"># define function to plot pickup traffic density</span>
<span class="k">def</span> <span class="nf">plot_traffic</span><span class="p">(</span><span class="n">traffic</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="n">days</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;monday&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;tuesday&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;wednesday&#39;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;thursday&#39;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;friday&#39;</span> <span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;saturday&#39;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;sunday&#39;</span> <span class="p">:</span> <span class="mi">6</span><span class="p">}</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">traffic</span><span class="p">[</span><span class="n">y</span><span class="o">-</span><span class="mi">2009</span><span class="p">,</span><span class="n">days</span><span class="p">[</span><span class="n">d</span><span class="p">],</span><span class="n">h</span><span class="p">,::</span><span class="o">-</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> <span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">traffic</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;h=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
        <span class="c1">#cx.add_basemap(axs[h],crs=4236)</span>
        
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Pickup traffic density, year=</span><span class="si">{}</span><span class="s2">, day=</span><span class="si">{}</span><span class="s2"> (max_pickups=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">traffic</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
</pre></div>
</div>
</div>
</div>
<p>Now, let’s calculate the density and visualize the plots.</p>
<p>NOTE: the quality of the plots depends on the number of datapoints used. This notebook uses by default 500k points, which is not sufficient for good traffic density plots. Increase the number of points and you get better plots.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">traffic</span> <span class="o">=</span> <span class="n">calculate_trafic_density</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_traffic</span><span class="p">(</span><span class="n">traffic</span><span class="p">,</span> <span class="mi">2015</span><span class="p">,</span> <span class="s1">&#39;monday&#39;</span><span class="p">)</span>
<span class="n">plot_traffic</span><span class="p">(</span><span class="n">traffic</span><span class="p">,</span> <span class="mi">2015</span><span class="p">,</span> <span class="s1">&#39;friday&#39;</span><span class="p">)</span>
<span class="n">plot_traffic</span><span class="p">(</span><span class="n">traffic</span><span class="p">,</span> <span class="mi">2015</span><span class="p">,</span> <span class="s1">&#39;sunday&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/nyc-taxi-fare-data-exploration_41_0.png" src="../_images/nyc-taxi-fare-data-exploration_41_0.png" />
<img alt="../_images/nyc-taxi-fare-data-exploration_41_1.png" src="../_images/nyc-taxi-fare-data-exploration_41_1.png" />
<img alt="../_images/nyc-taxi-fare-data-exploration_41_2.png" src="../_images/nyc-taxi-fare-data-exploration_41_2.png" />
</div>
</div>
</div>
<div class="section" id="distance-and-time-visualisations">
<h2>Distance and time visualisations<a class="headerlink" href="#distance-and-time-visualisations" title="Permalink to this headline">¶</a></h2>
<p>Before building a model I want to test some basic ‘intuition’:</p>
<ul class="simple">
<li><p>The longer the distance between pickup and dropoff location, the higher the fare.</p></li>
<li><p>Some trips, like to/from an airport, are fixed fee.</p></li>
<li><p>Fare at night is different from day time.</p></li>
</ul>
<p>So, let’s check.</p>
<div class="section" id="the-longer-the-distance-between-pickup-and-dropoff-location-the-higher-the-fare">
<h3>The longer the distance between pickup and dropoff location, the higher the fare<a class="headerlink" href="#the-longer-the-distance-between-pickup-and-dropoff-location-the-higher-the-fare" title="Permalink to this headline">¶</a></h3>
<p>To visualize the distance - fare relation we need to calculate the distance of a trip first.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add new column to dataframe with distance in miles</span>
<span class="n">gdf</span><span class="o">.</span><span class="n">trip_distance</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;distance miles&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Histogram ride distances in miles&#39;</span><span class="p">)</span>
<span class="n">gdf</span><span class="o">.</span><span class="n">trip_distance</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count    998236.000000
mean          2.905731
std           2.954355
min           0.000000
25%           1.090000
50%           1.930000
75%           3.670000
max         121.050000
Name: trip_distance, dtype: float64
</pre></div>
</div>
<img alt="../_images/nyc-taxi-fare-data-exploration_44_1.png" src="../_images/nyc-taxi-fare-data-exploration_44_1.png" />
</div>
</div>
<p>It seems that most rides are just short rides, with a small peak at ~3 miles.
Let’s also see the influence of <code class="docutils literal notranslate"><span class="pre">passenger_count</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gdf</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;passenger_count&#39;</span><span class="p">,</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">,</span> <span class="s1">&#39;fare_amount&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th></th>
      <th>rate_code</th>
      <th>pickup_longitude</th>
      <th>pickup_latitude</th>
      <th>dropoff_longitude</th>
      <th>dropoff_latitude</th>
      <th>extra</th>
      <th>mta_tax</th>
      <th>tip_amount</th>
      <th>tolls_amount</th>
      <th>total_amount</th>
      <th>...</th>
      <th>driving_speed_miles_per_hour</th>
      <th>tip_rate</th>
      <th>pickup_year</th>
      <th>pickup_month</th>
      <th>pickup_hour</th>
      <th>dropoff_year</th>
      <th>dropoff_month</th>
      <th>dropoff_hour</th>
      <th>pickup_codes</th>
      <th>dropoff_codes</th>
    </tr>
    <tr>
      <th>passenger_count</th>
      <th>trip_distance</th>
      <th>fare_amount</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">1</th>
      <th rowspan="5" valign="top">0.00</th>
      <th>0.00</th>
      <td>2.48</td>
      <td>-73.917397</td>
      <td>40.770695</td>
      <td>-73.917416</td>
      <td>40.770677</td>
      <td>0.0025</td>
      <td>0.015</td>
      <td>0.8475</td>
      <td>0.5027</td>
      <td>1.360700</td>
      <td>...</td>
      <td>0.0</td>
      <td>5.00</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>11.78</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>11.69</td>
      <td>2.795000</td>
      <td>2.810000</td>
    </tr>
    <tr>
      <th>0.01</th>
      <td>5.0</td>
      <td>-73.931686</td>
      <td>40.779707</td>
      <td>-73.931685</td>
      <td>40.779743</td>
      <td>0.0000</td>
      <td>0.000</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>0.027647</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>16.294118</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>16.352941</td>
      <td>2.411765</td>
      <td>2.411765</td>
    </tr>
    <tr>
      <th>0.02</th>
      <td>5.0</td>
      <td>-73.900241</td>
      <td>40.765770</td>
      <td>-73.900243</td>
      <td>40.765812</td>
      <td>0.0000</td>
      <td>0.000</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>0.020000</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>14.666667</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>15.0</td>
      <td>2.000000</td>
      <td>2.000000</td>
    </tr>
    <tr>
      <th>0.04</th>
      <td>5.0</td>
      <td>-73.954048</td>
      <td>40.587318</td>
      <td>-73.954063</td>
      <td>40.587318</td>
      <td>0.0000</td>
      <td>0.000</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>0.040000</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>9.0</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>9.0</td>
      <td>5.000000</td>
      <td>5.000000</td>
    </tr>
    <tr>
      <th>0.05</th>
      <td>5.0</td>
      <td>-73.870756</td>
      <td>40.734220</td>
      <td>-73.870778</td>
      <td>40.734249</td>
      <td>0.0000</td>
      <td>0.000</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>0.150000</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>10.333333</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>10.333333</td>
      <td>1.333333</td>
      <td>1.333333</td>
    </tr>
    <tr>
      <th>...</th>
      <th>...</th>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">9</th>
      <th rowspan="2" valign="top">0.00</th>
      <th>11.80</th>
      <td>5.0</td>
      <td>-73.954849</td>
      <td>40.671097</td>
      <td>-73.954849</td>
      <td>40.671093</td>
      <td>0.0000</td>
      <td>0.000</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>11.800000</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>15.0</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>15.0</td>
      <td>1.000000</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>80.00</th>
      <td>5.0</td>
      <td>-74.125137</td>
      <td>40.623013</td>
      <td>-74.125137</td>
      <td>40.623013</td>
      <td>0.0000</td>
      <td>0.000</td>
      <td>16.0000</td>
      <td>0.0000</td>
      <td>96.000000</td>
      <td>...</td>
      <td>0.0</td>
      <td>16.67</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>14.0</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>14.0</td>
      <td>3.000000</td>
      <td>3.000000</td>
    </tr>
    <tr>
      <th>0.10</th>
      <th>9.80</th>
      <td>5.0</td>
      <td>-73.865440</td>
      <td>40.837101</td>
      <td>-73.865112</td>
      <td>40.835457</td>
      <td>0.0000</td>
      <td>0.000</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>9.800000</td>
      <td>...</td>
      <td>108.0</td>
      <td>0.00</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>23.0</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>23.0</td>
      <td>6.000000</td>
      <td>6.000000</td>
    </tr>
    <tr>
      <th>0.89</th>
      <th>9.00</th>
      <td>5.0</td>
      <td>-73.809669</td>
      <td>40.698147</td>
      <td>-73.819489</td>
      <td>40.701962</td>
      <td>0.0000</td>
      <td>0.000</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>9.000000</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>17.0</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>18.0</td>
      <td>6.000000</td>
      <td>6.000000</td>
    </tr>
    <tr>
      <th>6.05</th>
      <th>25.00</th>
      <td>5.0</td>
      <td>-73.913612</td>
      <td>40.845356</td>
      <td>-73.950699</td>
      <td>40.800522</td>
      <td>0.0000</td>
      <td>0.000</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>25.000000</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>3.0</td>
      <td>2015.0</td>
      <td>6.0</td>
      <td>4.0</td>
      <td>6.000000</td>
      <td>6.000000</td>
    </tr>
  </tbody>
</table>
<p>90305 rows × 26 columns</p>
</div></div></div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">passenger_count</span></code> of zero seems odd. Perhaps a taxi transporting some goods or an administration error?</p>
<p>Instead of looking to the <code class="docutils literal notranslate"><span class="pre">fare_amount</span></code> using the ‘fare per mile’ also provides some insights.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Average $USD/Mile : </span><span class="si">{:0.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">fare_amount</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">gdf</span><span class="o">.</span><span class="n">trip_distance</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Average $USD/Mile : 4.31
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># scatter plot distance - fare</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">trip_distance</span><span class="p">,</span> <span class="n">gdf</span><span class="o">.</span><span class="n">fare_amount</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;distance mile&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;fare $USD&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;All data&#39;</span><span class="p">)</span>

<span class="c1"># zoom in on part of data</span>
<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">trip_distance</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">fare_amount</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">trip_distance</span><span class="p">,</span> <span class="n">gdf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">fare_amount</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;distance mile&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;fare $USD&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Zoom in on distance &lt; 15 mile, fare &lt; $100&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/nyc-taxi-fare-data-exploration_49_0.png" src="../_images/nyc-taxi-fare-data-exploration_49_0.png" />
</div>
</div>
<p>From this plot we notice:</p>
<ul class="simple">
<li><p>There are trips with zero distance but with a non-zero fare. Could this be trips from and to the same location? Predicting these fares will be difficult as there is likely not sufficient information in the dataset.  They may also be due to cabbies not reporting distance but reporting a fare.</p></li>
<li><p>There are some trips with &gt;25 miles travel distance but low fare.</p></li>
<li><p>The horizontal lines in the right plot might indicate again the fixed fare trips to/from JFK airport.</p></li>
<li><p>Overall there seems to be a (linear) relation between distance and fare with an average rate of +/- 100/20 = 5 $USD/mile.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># remove datapoints with distance &lt;0.05 milesf</span>
<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">trip_distance</span> <span class="o">&gt;=</span> <span class="mf">0.05</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Old size: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">))</span>
<span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;New size: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Old size: 998236
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>New size: 983790
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="some-trips-like-to-from-an-airport-are-fixed-fee">
<h2>Some trips, like to/from an airport, are fixed fee<a class="headerlink" href="#some-trips-like-to-from-an-airport-are-fixed-fee" title="Permalink to this headline">¶</a></h2>
<p>Another way to explore this data is to check trips to/from well known places. E.g. a trip to JFK airport. Depending on the distance, a trip to an airport is often a fixed price. Let’s see.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># JFK airport coordinates, see https://www.travelmath.com/airport/JFK</span>
<span class="n">jfk</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">73.7822222222</span><span class="p">,</span> <span class="mf">40.6441666667</span><span class="p">)</span>
<span class="n">nyc</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">74.0063889</span><span class="p">,</span> <span class="mf">40.7141667</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">plot_location_fare</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>
    <span class="c1"># select all datapoints with dropoff location within range of airport</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">distance</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">pickup_latitude</span><span class="p">,</span> <span class="n">gdf</span><span class="o">.</span><span class="n">pickup_longitude</span><span class="p">,</span> <span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nb">range</span><span class="p">)</span>
    <span class="n">gdf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">fare_amount</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;fare $USD&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Histogram pickup location within </span><span class="si">{}</span><span class="s1"> miles of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">range</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">distance</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">dropoff_latitude</span><span class="p">,</span> <span class="n">gdf</span><span class="o">.</span><span class="n">dropoff_longitude</span><span class="p">,</span> <span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nb">range</span><span class="p">)</span>
    <span class="n">gdf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">fare_amount</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;fare $USD&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Histogram dropoff location within </span><span class="si">{}</span><span class="s1"> miles of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">range</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    
<span class="n">plot_location_fare</span><span class="p">(</span><span class="n">jfk</span><span class="p">,</span> <span class="s1">&#39;JFK Airport&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/nyc-taxi-fare-data-exploration_53_0.png" src="../_images/nyc-taxi-fare-data-exploration_53_0.png" />
</div>
</div>
<p>The majority of rides seem to be going to the airport in this set.  The price is probably fxed around 55-60 dollars.  The price from the airport to manhattan is probably around 25-27 dollars.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ewr</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">74.175</span><span class="p">,</span> <span class="mf">40.69</span><span class="p">)</span> <span class="c1"># Newark Liberty International Airport, see https://www.travelmath.com/airport/EWR</span>
<span class="n">lgr</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">73.87</span><span class="p">,</span> <span class="mf">40.77</span><span class="p">)</span> <span class="c1"># LaGuardia Airport, see https://www.travelmath.com/airport/LGA</span>
<span class="n">plot_location_fare</span><span class="p">(</span><span class="n">ewr</span><span class="p">,</span> <span class="s1">&#39;Newark Airport&#39;</span><span class="p">)</span>
<span class="n">plot_location_fare</span><span class="p">(</span><span class="n">lgr</span><span class="p">,</span> <span class="s1">&#39;LaGuardia Airport&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/nyc-taxi-fare-data-exploration_55_0.png" src="../_images/nyc-taxi-fare-data-exploration_55_0.png" />
<img alt="../_images/nyc-taxi-fare-data-exploration_55_1.png" src="../_images/nyc-taxi-fare-data-exploration_55_1.png" />
</div>
</div>
<p>Trips from newark are rare.  Trips to newark are occasional.  Laguardia pickpus and dropoff rates are nearly identical.  Interestingly there are more dropoffs to the airport.  The rate is fairly normal with shifting fares it seems according to distance.</p>
</div>
<div class="section" id="fare-per-mile">
<h2>Fare Per Mile<a class="headerlink" href="#fare-per-mile" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Lambada ensure that memory issues do not arise from improperly copying. It takes forever though.  I could probaly vectorize the function. </span>

<span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;fare_per_mile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">fare_amount</span><span class="o">/</span><span class="n">x</span><span class="o">.</span><span class="n">trip_distance</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">gdf</span><span class="o">.</span><span class="n">fare_per_mile</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jnapolitano/venvs/sphinx-build/lib/python3.9/site-packages/geopandas/geodataframe.py:1351: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  super().__setitem__(key, value)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count    983790.000000
mean          5.874245
std          25.184516
min           0.000000
25%           4.000000
50%           4.852321
75%           6.000000
max        7000.000000
Name: fare_per_mile, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">trip_distance</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">fare_amount</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">trip_distance</span><span class="p">,</span> <span class="n">gdf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">fare_per_mile</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;distance mile&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;fare per distance mile&#39;</span><span class="p">)</span>

<span class="c1"># theta here is estimated by hand</span>
<span class="n">theta</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">x</span> <span class="o">+</span> <span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/nyc-taxi-fare-data-exploration_59_0.png" src="../_images/nyc-taxi-fare-data-exploration_59_0.png" />
</div>
</div>
<p>There is a large spread at low distances. Probably due to slow traffic.  There is also some values reported as high as 1400.  I assume this is due to cabbies padding and cleaning their earnings.</p>
<p>Let’s continue with the time vs fare per distance analysis. Next we use a pandas pivot table to calculate a summary and to plot them.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># display pivot table</span>
<span class="n">gdf</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="s1">&#39;fare_per_mile&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;pickup_hour&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;pickup_year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Fare $USD / mile&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/nyc-taxi-fare-data-exploration_62_0.png" src="../_images/nyc-taxi-fare-data-exploration_62_0.png" />
</div>
</div>
<p>It can be clearly seen that the fare $USD/mile varies over the hour.</p>
<p>A more in-depth analysis of the fare / time dependency is illustrated below. Here, I calculate per year and per hour the fare and do a linear regression.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>

<span class="c1"># plot all years</span>
<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">pickup_year</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="c1"># create figure</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    
    <span class="c1"># plot for all hours</span>
    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">trip_distance</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">fare_amount</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">pickup_hour</span> <span class="o">==</span> <span class="n">h</span><span class="p">)</span> <span class="o">&amp;</span> \
              <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">pickup_year</span> <span class="o">==</span> <span class="n">year</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">pickup_hour</span><span class="p">,</span> <span class="n">gdf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">fare_amount</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;distance miles&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;fare $USD&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">70</span><span class="p">))</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">trip_distance</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">gdf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">fare_amount</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">xx</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;hour = </span><span class="si">{}</span><span class="s1">, theta=(</span><span class="si">{:0.2f}</span><span class="s1">,</span><span class="si">{:0.2f}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Year = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/nyc-taxi-fare-data-exploration_65_0.png" src="../_images/nyc-taxi-fare-data-exploration_65_0.png" />
</div>
</div>
</div>
<div class="section" id="fare-varies-with-pickup-location">
<h2>Fare varies with pickup location<a class="headerlink" href="#fare-varies-with-pickup-location" title="Permalink to this headline">¶</a></h2>
<p>To visualize whether the fare per km varies with the location the distance to the center of New York is calculated.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add new column to dataframe with distance in mile</span>
<span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;distance_to_center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">nyc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nyc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gdf</span><span class="o">.</span><span class="n">pickup_latitude</span><span class="p">,</span> <span class="n">gdf</span><span class="o">.</span><span class="n">pickup_longitude</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jnapolitano/venvs/sphinx-build/lib/python3.9/site-packages/geopandas/geodataframe.py:1351: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  super().__setitem__(key, value)
</pre></div>
</div>
</div>
</div>
<p>Plotting the distance to NYC center vs distance of the trip vs the fare amount gives some insight in this complex relation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">distance_to_center</span><span class="p">,</span> <span class="n">gdf</span><span class="o">.</span><span class="n">trip_distance</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">fare_amount</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> 
                     <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;pickup distance from NYC center&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;distance miles&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;All data&#39;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;fare_amount&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">)</span>

<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">distance_to_center</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">trip_distance</span> <span class="o">&lt;</span> <span class="mi">35</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">distance_to_center</span><span class="p">,</span> <span class="n">gdf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">trip_distance</span><span class="p">,</span> 
                     <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">fare_amount</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;pickup distance from NYC center&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;distance miles&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Zoom in&#39;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;fare_amount&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_25201/3705102942.py:7: MatplotlibDeprecationWarning: Auto-removal of grids by pcolor() and pcolormesh() is deprecated since 3.5 and will be removed two minor releases later; please call grid(False) first.
  cbar = fig.colorbar(im, ax=axs[0])
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_25201/3705102942.py:16: MatplotlibDeprecationWarning: Auto-removal of grids by pcolor() and pcolormesh() is deprecated since 3.5 and will be removed two minor releases later; please call grid(False) first.
  cbar = fig.colorbar(im, ax=axs[1])
</pre></div>
</div>
<img alt="../_images/nyc-taxi-fare-data-exploration_69_2.png" src="../_images/nyc-taxi-fare-data-exploration_69_2.png" />
</div>
</div>
<p>There are a lot of ‘green’ dots, which is about $50 to $60 fare amount near 13 miles distance of NYC center of distrance of trip. This could be due to trips from/to JFK airport. Let’s remove them to see what we’re left with.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;pickup_distance_to_jfk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">jfk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">jfk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gdf</span><span class="o">.</span><span class="n">pickup_latitude</span><span class="p">,</span> <span class="n">gdf</span><span class="o">.</span><span class="n">pickup_longitude</span><span class="p">)</span>
<span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;dropoff_distance_to_jfk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">jfk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">jfk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gdf</span><span class="o">.</span><span class="n">dropoff_latitude</span><span class="p">,</span> <span class="n">gdf</span><span class="o">.</span><span class="n">dropoff_longitude</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jnapolitano/venvs/sphinx-build/lib/python3.9/site-packages/geopandas/geodataframe.py:1351: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  super().__setitem__(key, value)
/home/jnapolitano/venvs/sphinx-build/lib/python3.9/site-packages/geopandas/geodataframe.py:1351: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  super().__setitem__(key, value)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># remove all to/from JFK trips</span>
<span class="n">idx</span> <span class="o">=</span> <span class="o">~</span><span class="p">((</span><span class="n">gdf</span><span class="o">.</span><span class="n">pickup_distance_to_jfk</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">dropoff_distance_to_jfk</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">distance_to_center</span><span class="p">,</span> <span class="n">gdf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">trip_distance</span><span class="p">,</span> 
                    <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">fare_amount</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> 
                     <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;pickup distance from NYC center&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;distance miles&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;All data&#39;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;fare_amount&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">)</span>

<span class="n">idx1</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">distance_to_center</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">trip_distance</span> <span class="o">&lt;</span> <span class="mi">35</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span><span class="o">.</span><span class="n">distance_to_center</span><span class="p">,</span> <span class="n">gdf</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span><span class="o">.</span><span class="n">trip_distance</span><span class="p">,</span> 
                     <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span><span class="o">.</span><span class="n">fare_amount</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;pickup distance from NYC center&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;distance miles&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Zoom in&#39;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;fare_amount&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_25201/1958965034.py:11: MatplotlibDeprecationWarning: Auto-removal of grids by pcolor() and pcolormesh() is deprecated since 3.5 and will be removed two minor releases later; please call grid(False) first.
  cbar = fig.colorbar(im, ax=axs[0])
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_25201/1958965034.py:20: MatplotlibDeprecationWarning: Auto-removal of grids by pcolor() and pcolormesh() is deprecated since 3.5 and will be removed two minor releases later; please call grid(False) first.
  cbar = fig.colorbar(im, ax=axs[1])
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;fare_amount&#39;)
</pre></div>
</div>
<img alt="../_images/nyc-taxi-fare-data-exploration_72_3.png" src="../_images/nyc-taxi-fare-data-exploration_72_3.png" />
</div>
</div>
<p>Now there are some ‘yellow’ dots (fare amount &gt; $80) left. To understand these datapoints we plot them on the map.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Pickup_locations</span>
<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">fare_amount</span><span class="o">&gt;</span><span class="mi">80</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">trip_distance</span><span class="o">&lt;</span><span class="mi">35</span><span class="p">)</span> 
<span class="n">gdf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mf">.01</span><span class="p">)</span>
<span class="n">cx</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/nyc-taxi-fare-data-exploration_74_0.png" src="../_images/nyc-taxi-fare-data-exploration_74_0.png" />
</div>
</div>
<p>There are a surpsing numbder of data points.<br />
I’ll remove all of the airports just to see what is left.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;pickup_distance_to_ewr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">ewr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ewr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gdf</span><span class="o">.</span><span class="n">pickup_latitude</span><span class="p">,</span> <span class="n">gdf</span><span class="o">.</span><span class="n">pickup_longitude</span><span class="p">)</span>
<span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;dropoff_distance_to_ewr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">ewr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ewr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">gdf</span><span class="o">.</span><span class="n">dropoff_latitude</span><span class="p">,</span><span class="n">gdf</span><span class="o">.</span><span class="n">dropoff_longitude</span><span class="p">)</span>
<span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;pickup_distance_to_lgr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">lgr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lgr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gdf</span><span class="o">.</span><span class="n">pickup_latitude</span><span class="p">,</span> <span class="n">gdf</span><span class="o">.</span><span class="n">pickup_longitude</span><span class="p">)</span>
<span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;dropoff_distance_to_lgr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">lgr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lgr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">gdf</span><span class="o">.</span><span class="n">dropoff_latitude</span><span class="p">,</span><span class="n">gdf</span><span class="o">.</span><span class="n">dropoff_longitude</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jnapolitano/venvs/sphinx-build/lib/python3.9/site-packages/geopandas/geodataframe.py:1351: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  super().__setitem__(key, value)
/home/jnapolitano/venvs/sphinx-build/lib/python3.9/site-packages/geopandas/geodataframe.py:1351: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  super().__setitem__(key, value)
/home/jnapolitano/venvs/sphinx-build/lib/python3.9/site-packages/geopandas/geodataframe.py:1351: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  super().__setitem__(key, value)
/home/jnapolitano/venvs/sphinx-build/lib/python3.9/site-packages/geopandas/geodataframe.py:1351: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  super().__setitem__(key, value)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># remove all to/from airport trips</span>
<span class="n">idx</span> <span class="o">=</span> <span class="o">~</span><span class="p">((</span><span class="n">gdf</span><span class="o">.</span><span class="n">pickup_distance_to_jfk</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">dropoff_distance_to_jfk</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
        <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">pickup_distance_to_ewr</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">dropoff_distance_to_ewr</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
        <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">pickup_distance_to_lgr</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">dropoff_distance_to_lgr</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">distance_to_center</span><span class="p">,</span> <span class="n">gdf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">trip_distance</span><span class="p">,</span> 
                    <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">fare_amount</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> 
                     <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;pickup distance from NYC center&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;distance miles&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;All data&#39;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;fare_amount&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">)</span>

<span class="n">idx1</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">distance_to_center</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">trip_distance</span> <span class="o">&lt;</span> <span class="mi">35</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span><span class="o">.</span><span class="n">distance_to_center</span><span class="p">,</span> <span class="n">gdf</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span><span class="o">.</span><span class="n">trip_distance</span><span class="p">,</span> 
                     <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span><span class="o">.</span><span class="n">fare_amount</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;pickup distance from NYC center&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;distance miles&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Zoom in&#39;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;fare_amount&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_25201/1133551596.py:13: MatplotlibDeprecationWarning: Auto-removal of grids by pcolor() and pcolormesh() is deprecated since 3.5 and will be removed two minor releases later; please call grid(False) first.
  cbar = fig.colorbar(im, ax=axs[0])
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_25201/1133551596.py:22: MatplotlibDeprecationWarning: Auto-removal of grids by pcolor() and pcolormesh() is deprecated since 3.5 and will be removed two minor releases later; please call grid(False) first.
  cbar = fig.colorbar(im, ax=axs[1])
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;fare_amount&#39;)
</pre></div>
</div>
<img alt="../_images/nyc-taxi-fare-data-exploration_77_3.png" src="../_images/nyc-taxi-fare-data-exploration_77_3.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">=</span> <span class="o">~</span><span class="p">((</span><span class="n">gdf</span><span class="o">.</span><span class="n">pickup_distance_to_jfk</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">dropoff_distance_to_jfk</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
        <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">pickup_distance_to_ewr</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">dropoff_distance_to_ewr</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
        <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">pickup_distance_to_lgr</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">dropoff_distance_to_lgr</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">gdf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mf">.01</span><span class="p">)</span>
<span class="n">cx</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/nyc-taxi-fare-data-exploration_78_0.png" src="../_images/nyc-taxi-fare-data-exploration_78_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">idx</span> <span class="o">=</span> <span class="o">~</span><span class="p">((</span><span class="n">gdf</span><span class="o">.</span><span class="n">pickup_distance_to_jfk</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">dropoff_distance_to_jfk</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
        <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">pickup_distance_to_ewr</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">dropoff_distance_to_ewr</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
        <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">pickup_distance_to_lgr</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">dropoff_distance_to_lgr</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">gdf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pickup_datetime</th>
      <th>dropoff_datetime</th>
      <th>store_and_fwd_flag</th>
      <th>rate_code</th>
      <th>pickup_longitude</th>
      <th>pickup_latitude</th>
      <th>dropoff_longitude</th>
      <th>dropoff_latitude</th>
      <th>passenger_count</th>
      <th>trip_distance</th>
      <th>...</th>
      <th>pickup_codes</th>
      <th>dropoff_codes</th>
      <th>fare_per_mile</th>
      <th>distance_to_center</th>
      <th>pickup_distance_to_jfk</th>
      <th>dropoff_distance_to_jfk</th>
      <th>pickup_distance_to_ewr</th>
      <th>dropoff_distance_to_ewr</th>
      <th>pickup_distance_to_lgr</th>
      <th>dropoff_distance_to_lgr</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2015-06-30T16:11:08+00:00</td>
      <td>2015-06-30T16:18:33+00:00</td>
      <td>N</td>
      <td>1</td>
      <td>-73.943321</td>
      <td>40.785267</td>
      <td>-73.935303</td>
      <td>40.800449</td>
      <td>1</td>
      <td>1.49</td>
      <td>...</td>
      <td>1</td>
      <td>1</td>
      <td>4.697987</td>
      <td>5.918672</td>
      <td>12.892809</td>
      <td>13.448219</td>
      <td>13.799921</td>
      <td>14.685756</td>
      <td>3.978615</td>
      <td>4.012150</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2015-06-30T14:06:56+00:00</td>
      <td>2015-06-30T14:44:59+00:00</td>
      <td>N</td>
      <td>1</td>
      <td>-73.951302</td>
      <td>40.689251</td>
      <td>-73.999634</td>
      <td>40.634769</td>
      <td>1</td>
      <td>5.74</td>
      <td>...</td>
      <td>1</td>
      <td>1</td>
      <td>4.442509</td>
      <td>3.360027</td>
      <td>9.392720</td>
      <td>11.417274</td>
      <td>11.719712</td>
      <td>9.951927</td>
      <td>7.017723</td>
      <td>11.550272</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2015-06-30T08:50:52+00:00</td>
      <td>2015-06-30T08:56:16+00:00</td>
      <td>N</td>
      <td>1</td>
      <td>-73.944077</td>
      <td>40.721775</td>
      <td>-73.944504</td>
      <td>40.714703</td>
      <td>1</td>
      <td>0.63</td>
      <td>...</td>
      <td>1</td>
      <td>1</td>
      <td>7.936508</td>
      <td>3.305239</td>
      <td>10.033491</td>
      <td>9.800867</td>
      <td>12.292802</td>
      <td>12.193473</td>
      <td>5.112552</td>
      <td>5.459760</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2015-06-30T03:55:39+00:00</td>
      <td>2015-06-30T04:09:03+00:00</td>
      <td>N</td>
      <td>1</td>
      <td>-73.854630</td>
      <td>40.742798</td>
      <td>-73.905746</td>
      <td>40.747269</td>
      <td>2</td>
      <td>3.26</td>
      <td>...</td>
      <td>1</td>
      <td>1</td>
      <td>3.834356</td>
      <td>8.188606</td>
      <td>7.799317</td>
      <td>9.623856</td>
      <td>17.169526</td>
      <td>14.644777</td>
      <td>2.044412</td>
      <td>2.442684</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2015-06-30T01:38:08+00:00</td>
      <td>2015-06-30T01:55:25+00:00</td>
      <td>N</td>
      <td>1</td>
      <td>-73.910698</td>
      <td>40.658485</td>
      <td>-73.971657</td>
      <td>40.697437</td>
      <td>1</td>
      <td>5.35</td>
      <td>...</td>
      <td>1</td>
      <td>1</td>
      <td>3.364486</td>
      <td>6.319518</td>
      <td>6.807010</td>
      <td>10.587665</td>
      <td>14.020143</td>
      <td>10.664917</td>
      <td>7.994278</td>
      <td>7.311837</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>999993</th>
      <td>2015-06-12T19:55:24+00:00</td>
      <td>2015-06-12T20:00:56+00:00</td>
      <td>N</td>
      <td>1</td>
      <td>-73.942421</td>
      <td>40.724537</td>
      <td>-73.954918</td>
      <td>40.730190</td>
      <td>1</td>
      <td>1.10</td>
      <td>...</td>
      <td>4</td>
      <td>4</td>
      <td>5.454545</td>
      <td>3.425569</td>
      <td>10.064154</td>
      <td>10.825493</td>
      <td>12.413151</td>
      <td>11.856367</td>
      <td>4.923186</td>
      <td>5.227063</td>
    </tr>
    <tr>
      <th>999996</th>
      <td>2015-06-12T14:03:49+00:00</td>
      <td>2015-06-12T14:23:32+00:00</td>
      <td>N</td>
      <td>1</td>
      <td>-73.949120</td>
      <td>40.785156</td>
      <td>-73.962090</td>
      <td>40.757912</td>
      <td>1</td>
      <td>2.68</td>
      <td>...</td>
      <td>4</td>
      <td>4</td>
      <td>5.597015</td>
      <td>5.748388</td>
      <td>13.087848</td>
      <td>12.269144</td>
      <td>13.530188</td>
      <td>12.095861</td>
      <td>4.270013</td>
      <td>4.891043</td>
    </tr>
    <tr>
      <th>999997</th>
      <td>2015-06-12T19:17:17+00:00</td>
      <td>2015-06-12T19:21:12+00:00</td>
      <td>N</td>
      <td>1</td>
      <td>-73.954285</td>
      <td>40.811398</td>
      <td>-73.960075</td>
      <td>40.810703</td>
      <td>1</td>
      <td>0.43</td>
      <td>...</td>
      <td>4</td>
      <td>4</td>
      <td>9.302326</td>
      <td>7.250292</td>
      <td>14.651729</td>
      <td>14.802803</td>
      <td>14.276534</td>
      <td>14.003821</td>
      <td>5.255514</td>
      <td>5.487386</td>
    </tr>
    <tr>
      <th>999998</th>
      <td>2015-06-12T10:01:36+00:00</td>
      <td>2015-06-12T10:10:51+00:00</td>
      <td>N</td>
      <td>1</td>
      <td>-73.946907</td>
      <td>40.819260</td>
      <td>-73.943138</td>
      <td>40.840080</td>
      <td>1</td>
      <td>1.70</td>
      <td>...</td>
      <td>4</td>
      <td>4</td>
      <td>5.000000</td>
      <td>7.900250</td>
      <td>14.856027</td>
      <td>15.943388</td>
      <td>14.909122</td>
      <td>15.960877</td>
      <td>5.269436</td>
      <td>6.170649</td>
    </tr>
    <tr>
      <th>999999</th>
      <td>2015-06-12T08:00:53+00:00</td>
      <td>2015-06-12T08:15:21+00:00</td>
      <td>N</td>
      <td>1</td>
      <td>-73.948685</td>
      <td>40.823864</td>
      <td>-73.969780</td>
      <td>40.793877</td>
      <td>1</td>
      <td>2.50</td>
      <td>...</td>
      <td>4</td>
      <td>4</td>
      <td>4.600000</td>
      <td>8.158682</td>
      <td>15.169326</td>
      <td>14.264151</td>
      <td>15.028074</td>
      <td>12.919959</td>
      <td>5.548808</td>
      <td>5.474714</td>
    </tr>
  </tbody>
</table>
<p>949194 rows × 48 columns</p>
</div></div></div>
</div>
<p>Removing the to/from airport trips doesn’t really change the outcome of the data.  The number of to and from trips within the set are marginal.</p>
</div>
<div class="section" id="final-thoughts">
<h2>Final Thoughts<a class="headerlink" href="#final-thoughts" title="Permalink to this headline">¶</a></h2>
<p>Very few of these cabs operatine in Manhattan. I was confused by this. I found that most green cabs operate in the boroughs.  The few number of these going to the center, accounted for such high rates as this is not their typical range of operation.</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "finance"
        },
        kernelOptions: {
            kernelName: "finance",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'finance'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="question_1.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Part 1: BigQuery and SQL</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="RecordingWeather.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Question 2a: CSV Solution</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Justin Napolitano<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>